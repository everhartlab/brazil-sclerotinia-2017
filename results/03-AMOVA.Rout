
R version 3.4.3 (2017-11-30) -- "Kite-Eating Tree"
Copyright (C) 2017 The R Foundation for Statistical Computing
Platform: x86_64-apple-darwin15.6.0 (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

[Previously saved workspace restored]

> # setwd("~/Thesis Project/Data Analysis")
> #
> # Make amova table from pegas output
> #
> #' Title
> #'
> #' @param am      The amova table from pegas
> #' @param within  A logical whether or not the lowest level is within individuals
> #'
> #' @return a data frame
> make_amova_table <- function(am, within = FALSE){
+   siggies <-
+     if (is.data.frame(am$varcomp))
+       setNames(am$varcomp, c("sigma", "P"))
+     else
+       data.frame( sigma = am$varcomp )
+   vars <- rownames(am$tab[-(nrow(am$tab) - 0:1), ])
+   sig  <- siggies$sigma
+   siggies$perc <- sig/sum(sig)
+ 
+   # Calculating phi statistics
+   nsig <- length(sig)
+   vnames <- paste(vars, "within", c("Total", vars[-length(vars)]))
+   phis <- matrix(0.0, nrow = nsig - 1, ncol = nsig - 1,
+                  dimnames = list(c("Total", vars[-length(vars)]),
+                                  vars))
+   for (i in 1:(nsig - 1)) {
+     for (j in i:(nsig - 1)) {
+       phis[i, j] <- sum(sig[i:j])/sum(sig[i:nsig])
+     }
+   }
+   wn <- c(diag(phis), if (within) phis[1, ncol(phis) - 1] else phis[1, ncol(phis)])
+ 
+   # creating the resulting data frame
+   res <- data.frame(am$tab[-nrow(am$tab), c(3, 1)],
+                     siggies,
+                     Phi = wn)
+   rownames(res) <- c(vnames, "Error")
+   res
+ }
> 
> library("poppr")
Loading required package: adegenet
Loading required package: ade4

   /// adegenet 2.1.1 is loaded ////////////

   > overview: '?adegenet'
   > tutorials/doc/questions: 'adegenetWeb()' 
   > bug reports/feature requests: adegenetIssues()


This is poppr version 2.6.1. To get started, type package?poppr
OMP parallel support: available
> library("tidyverse")
â”€â”€ [1mAttaching packages[22m â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ tidyverse 1.2.1 â”€â”€
[32mâœ”[39m [34mggplot2[39m 2.2.1     [32mâœ”[39m [34mpurrr  [39m 0.2.4
[32mâœ”[39m [34mtibble [39m 1.4.2     [32mâœ”[39m [34mdplyr  [39m 0.7.4
[32mâœ”[39m [34mtidyr  [39m 0.8.0     [32mâœ”[39m [34mstringr[39m 1.3.0
[32mâœ”[39m [34mreadr  [39m 1.1.1     [32mâœ”[39m [34mforcats[39m 0.2.0
â”€â”€ [1mConflicts[22m â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ tidyverse_conflicts() â”€â”€
[31mâœ–[39m [34mdplyr[39m::[32mfilter()[39m masks [34mstats[39m::filter()
[31mâœ–[39m [34mdplyr[39m::[32mlag()[39m    masks [34mstats[39m::lag()
> if (!interactive()) options(width = 200)
> enc <- getOption("encoding")
> options(encoding = "iso-8859-1")
> CD <- readRDS(here::here("data", "full-genclone-object.rds"))
> CDdist <- bruvo.dist(CD, replen = other(CD)$REPLEN)
> set.seed(2017 - 11 - 29)
> CDamova <- pegas::amova(CDdist ~ Continent/Country/Population, data = strata(CD), nperm = 1000)
> make_amova_table(CDamova) %>%
+   tibble::rownames_to_column(var = "Levels") %>%
+   dplyr::mutate(Levels = trimws(Levels)) %>%
+   dplyr::select(Levels, dplyr::everything()) %T>%
+   print() %>%
+   dplyr::mutate_if(is.numeric, signif, 3) %>%
+   readr::write_csv("tables/table2.csv")
                     Levels df       SSD       sigma          P       perc        Phi
1    Continent within Total  1 1.4109424 0.013098007 0.00000000 0.10749599 0.10749599
2  Country within Continent  1 0.4154938 0.009637943 0.99900100 0.07909907 0.08862601
3 Population within Country  5 1.2802883 0.015010351 0.04295704 0.12319069 0.15145063
4                     Error 86 7.2326149 0.084100173         NA 0.69021425 0.30978575
> 
> # Pairwise AMOVA
> 
> CDpops <- seppop(CD, ~Population)
> out <- matrix(0, nrow = nPop(CD), ncol = nPop(CD),
+               dimnames = list(popNames(CD), popNames(CD)))
> single_pair_amova <- function(pair = NULL, popdf = NULL, column = "Population", dist, ...){
+   if (is.null(pair)) stop("pair must be a vector specifying the populations to include")
+   if (is.null(popdf)) stop("popdf must be a data frame specifying the population of each individual")
+   to_subset <- popdf[[column]] %in% pair
+   popdf <- popdf[to_subset, , drop = FALSE]
+   dist <- as.dist(as.matrix(dist)[to_subset, to_subset, drop = FALSE])
+   form <- as.formula("dist ~ Population", env = environment())
+   pegas::amova(form, data = popdf, ...)
+ }
> to_test <- combn(names(CDpops), 2)
> 
> res <- apply(to_test, 
+              MARGIN = 2, 
+              FUN = single_pair_amova, 
+                popdf = strata(CD), dist = CDdist, nperm = 999)
> for (i in seq(res)){
+   phi_location <- lower.tri(out)
+   p_location   <- upper.tri(out)
+   varcomp <- res[[i]]$varcomp
+   out[phi_location][i] <- varcomp$sigma2[1]/sum(varcomp$sigma2)
+   out[p_location][i]   <- varcomp$P.value[1]
+ }
> out %>% 
+   signif(3) %>% 
+   as.data.frame() %>% 
+   tibble::rownames_to_column(var = " ") %>%
+   readr::write_csv(here::here("tables/pair_amova.csv"))
> # Visualizing the Brazilian Populations
> outtype <- out
> outtype[lower.tri(outtype)] <- "Phi"
> outtype[upper.tri(outtype)] <- "P-value"
> diag(outtype) <- NA
> (outtype <- reshape2::melt(outtype, value.name = "type") %>% as_tibble())
[38;5;246m# A tibble: 64 x 3[39m
   Var1               Var2      type   
   [3m[38;5;246m<fct>[39m[23m              [3m[38;5;246m<fct>[39m[23m     [3m[38;5;246m<fct>[39m[23m  
[38;5;250m 1[39m Midwest            Midwest   [31mNA[39m     
[38;5;250m 2[39m Argentina          Midwest   Phi    
[38;5;250m 3[39m GÃ³ias              Midwest   Phi    
[38;5;250m 4[39m ParanÃ¡             Midwest   Phi    
[38;5;250m 5[39m Bahia              Midwest   Phi    
[38;5;250m 6[39m Rio Grande do Sul  Midwest   Phi    
[38;5;250m 7[39m Minas Gerias       Midwest   Phi    
[38;5;250m 8[39m Mato Grosso do Sul Midwest   Phi    
[38;5;250m 9[39m Midwest            Argentina P-value
[38;5;250m10[39m Argentina          Argentina [31mNA[39m     
[38;5;246m# ... with 54 more rows[39m
> reshape2::melt(out) %>% 
+   full_join(outtype) %>%
+   filter(!Var1 %in% c("Argentina", "Midwest"),
+          !Var2 %in% c("Argentina", "Midwest")) %>%
+   ggplot(aes(x = Var1, y = fct_rev(Var2), fill = value)) + 
+   geom_tile() + 
+   geom_text(aes(label = round(value, 3), color = type)) +
+   theme_bw() +
+   theme(axis.title = element_blank()) +
+   theme(axis.text.x = element_text(
+                                    angle = 90,
+                                    hjust = 1,
+                                    vjust = 0.5
+                                  )) + 
+   viridis::scale_fill_viridis() + 
+   scale_color_manual(values = c(`P-value` = "firebrick",
+                                 Phi = "black")) +
+   coord_fixed()
Joining, by = c("Var1", "Var2")
>   
> options(encoding = enc)
> 
